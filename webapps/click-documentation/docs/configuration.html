<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
 "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
 <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
 <meta name="Author" content="Malcolm Edgar"/>
 <link rel="stylesheet" type="text/css" href="../help.css"/>
</head>
<body>
  
<h1>Configuration</h1>
<p/>
This section discusses how to setup configure a Click web application and
covers to following topics: 
<ul>
  <li><a href="#servlet-configuration">Servlet Configuration</a> - how to setup the ClickServlet
  </li>
  <li><a href="#application-configuration">Application Configuration</a> - how to configure the Click application
   descriptor
  </li>
  <li><a href="#velocity-properties">Velocity Properties</a> - how to configure the Velocity runtime properties
  </li>
  <li><a href="#auto-deployed-files">Auto Deployed Files</a> - automatically deployed Click files
  </li>
</ul>

<p>&nbsp;</p>

The Click configuration files include:
<table style="margin: 1em">
<tr valign="top">
  <td>
    <img alt="Click application configuration files" src="../images/config-files.png"/>  
  </td>
  <td>
<ul>
 <li>WEB-INF/<a target='topic' href="#application-configuration">click.xml</a>
 &nbsp; - &nbsp; Application Configuration (<b>required</b>)
 </li>
 <li>WEB-INF/<a target='topic' href="#velocity-properties">velocity.properties</a>
 &nbsp; - &nbsp; Velocity Properties (optional)
 </li>
 <li>WEB-INF/<a target='topic' href="#servlet-configuration">web.xml</a>
 &nbsp; - &nbsp; Servlet Configuration (<b>required</b>)
 </li>
</ul>    
  </td>
</tr>
</table>

<a name="servlet-configuration" class="heading"><h2>Servlet Configuration</h2></a>

For a Click web application to function the 
<a target="topic" href="click-api/net/sf/click/ClickServlet.html">ClickServlet</a>
must be configured in the web application's <tt>/WEB-INF/web.xml</tt> file. 
A simple web application which maps all <tt>*.htm</tt> requests to a ClickServlet 
is provided below.

<pre class="codeConfig">
&lt;web-app&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;<span class="blue">click-servlet</span>&lt;/servlet-name&gt;
    &lt;servlet-class&gt;<span class="red">net.sf.click.ClickServlet</span>&lt;/servlet-class&gt;
    &lt;load-on-startup&gt;<span class="red">0</span>&lt;/load-on-startup&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;<span class="blue">click-servlet</span>&lt;/servlet-name&gt;
    &lt;url-pattern&gt;<span class="red">*.htm</span>&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</pre>

By default the <tt>ClickServlet</tt> will attempt to load an application
configuration file using the path: &nbsp; <tt>/WEB-INF/click.xml</tt>

<h3>Servlet Mapping</h3>
By convention all Click page templates should have a .htm extension, and
the ClickServlet should be mapped to process all *.htm URL requests. With
this convention you have all the static HTML pages use a .html extension
and they will not be processed as Click pages.

<h3>Load On Startup</h3>
Note you should always set <tt>load-on-startup</tt> element to be 0 so the
servlet is initialized when the server is started. This will prevent any
delay for the first client which uses the application. 
<p/>
The <tt>ClickServlet</tt> performs as much work as possible at startup to
improve performance later on. The Click start up and caching strategy is
configured with the Click application mode element in the "<tt>click.xml</tt>"
config file.


<a name="application-configuration" class="heading"><h2>Application Configuration</h2></a>

The heart of a Click application is the <tt>click.xml</tt> configuration file.
This file specifies the application pages, headers, the format object and the 
applications mode. 

<p/>
See <a target='topic' href="click-dtd.html">Click DTD</a> for the click-app XML definition.  
 
<p/>
A simple Click app config file is provided below:

<pre class="codeConfig">
&lt;click-app&gt; 
  &lt;pages&gt;
    &lt;page path="<span class="blue">index.htm</span>" classname="<span class="blue">com.mycorp.page.Home</span>"/&gt;
    &lt;page path="<span class="blue">login.htm</span>" classname="<span class="blue">com.mycorp.page.Login</span>"/&gt;
    &lt;page path="<span class="blue">logout.htm</span>" classname="<span class="blue">com.mycorp.page.Logout</span>"/&gt;    
    &lt;page path="<span class="blue">search.htm</span>" classname="<span class="blue">com.mycorp.page.Search</span>"/&gt;
  &lt;/pages&gt;
&lt;/click-app&gt; 
</pre>

<p>
An example of a fully optioned up config file is:

<pre class="codeConfig">
&lt;click-app&gt; 
  &lt;pages&gt;
    &lt;page path="<span class="blue">index.htm</span>" classname="<span class="blue">com.mycorp.page.Home</span>"/&gt;
    &lt;page path="<span class="blue">login.htm</span>" classname="<span class="blue">com.mycorp.page.Login</span>"/&gt;
    &lt;page path="<span class="blue">logout.htm</span>" classname="<span class="blue">com.mycorp.page.Logout</span>"/&gt;    
    &lt;page path="<span class="blue">search.htm</span>" classname="<span class="blue">com.mycorp.page.Search</span>"/&gt;
  &lt;/pages&gt;
  &lt;headers&gt;
    &lt;header name="<span class="blue">Pragma</span>" value="<span class="blue">no-cache</span>"/&gt;
    &lt;header name="<span class="blue">Cache-Control</span>" value="<span class="blue">no-cache</span>"/&gt;
  &lt;/headers&gt;
  &lt;format classname="<span class="blue">com.mycorp.util.Format</span>"/&gt;
  &lt;mode value="<span class="blue">debug</span>"/&gt;
&lt;/click-app&gt; 
</pre>


<a name="application-pages" class="heading"><h3>Pages</h3></a>

The first major element of the click-app is the mandatory <tt>pages</tt> element 
which defines the list of Click pages.

<pre class="codeDtd">
&lt;!ELEMENT <span class="blue">pages</span> (<span class="red">page</span>*)&gt; 
</pre>

The <span class="red">page</span> element defines the Click application pages.

<pre class="codeDtd">
&lt;!ELEMENT <span class="red">page</span> (<span class="blue">header</span>*)&gt;
   &lt;!ATTLIST page <span class="blue">path</span> CDATA #REQUIRED&gt;
   &lt;!ATTLIST page <span class="blue">classname</span> CDATA #REQUIRED&gt; 
</pre>

Each page <span class="blue">path</span> must be unique, as the Click application maps HTTP requests to the page paths.
<p/>
The Click application will create a new Page instance for the given request using
the configured page <span class="blue">classname</span>. All pages must subclass 
<a target="topic" href="click-api/net/sf/click/Page.html">Page</a>  
and provide a public no arguments constructor, so they can be instantiated.
<p/>
Pages can also define <span class="blue">header</span> values which are discussed
in the next topic.
<p/>
When the Click application starts up it will check all the page definitions. If there 
is a critical configuration error the ClickSerlvet will log an <tt>ERROR</tt> message and throw a
<a target="topic" href="servlet-api/javax/servlet/UnavailableException.html">UnavailableException</a>. 
If this occurs the click application will be permanently unavailable until the error is fixed 
and the web app is restarted.

<a name="application-headers" class="heading"><h3>Headers</h3></a>

The optional <tt>headers</tt> element defines a list of <tt>header</tt> elements
which is applied to all pages.

<pre class="codeDtd">
&lt;!ELEMENT <span class="blue">headers</span> (<span class="red">header</span>*)&gt; 
</pre>

The <tt><span class="red">header</span></tt> element defines header name and value
pairs which are applied to the 
<a target="topic" href="servlet-api/javax/servlet/http/HttpServletResponse.html">HttpServletResponse</a>.

<pre class="codeDtd">
&lt;!ELEMENT <span class="red">header</span> (#PCDATA)&gt;
   &lt;!ATTLIST header <span class="blue">name</span> CDATA #REQUIRED&gt;
   &lt;!ATTLIST header <span class="blue">value</span> CDATA #REQUIRED&gt;
   &lt;!ATTLIST header <span class="blue">type</span> (String|Integer|Date) "String"&gt;
</pre>

Page headers are set after the Page has been constructed and before <tt>onInit()</tt> is called.
Pages can then modify their 
<a target="topic" href="click-api/net/sf/click/Page.html#headers">headers</a> property.

<h4>Browser Caching</h4>

Headers are typically used to switch off browser caching. You can do this individually 
in pages or for all application pages by setting header values. For example to switch off
caching in the login page, note the value for a Date type should be a long number value:

<pre class="codeConfig">
&lt;page path="<span class="blue">login.htm</span>" classname="<span class="blue">com.mycorp.page.Login</span>"/&gt;
  &lt;header name="<span class="blue">Pragma</span>" value="<span class="blue">no-cache</span>"/&gt;
  &lt;header name="<span class="blue">Cache-Control</span>" value="<span class="blue">no-cache</span>"/&gt;
  &lt;header name="<span class="blue">Expires</span>" value="<span class="blue">1</span>" type="<span class="blue">Date</span>"/&gt;
&lt;/page&gt; 
</pre>

To apply header values globally define header values in the headers element. For example:

<pre class="codeConfig">
&lt;click-app&gt; 
  &lt;pages&gt;
     ..
  &lt;/pages&gt;
  &lt;headers&gt;
    &lt;header name="<span class="blue">Pragma</span>" value="<span class="blue">no-cache</span>"/&gt;
    &lt;header name="<span class="blue">Cache-Control</span>" value="<span class="blue">no-cache</span>"/&gt;
    &lt;header name="<span class="blue">Expires</span>" value="<span class="blue">1</span>" type="<span class="blue">Date</span>"/&gt;
  &lt;/headers&gt;
&lt;/click-app&gt; 
</pre>

<h4>GZIP Encoding</h4>

By setting a "<tt>Content-Encoding</tt>" header value to "<tt>gzip</tt>" the ClickServlet will apply 
GZIP compression to the HTML output. The ClickServlet will only compression if there is a "<tt>Accept-Encoding</tt>" HTTP request header 
which includes <tt>gzip</tt>.

<pre class="codeConfig">
&lt;header name="<span class="blue">Content-Encoding</span>" value="<span class="blue">gzip</span>"/&gt; 
</pre>

Note there are alternative ways to apply HTTP compression such as using the Apache web server module
<tt>mod_gzip</tt>, or using a ServletFilter.


<a name="application-format" class="heading"><h3>Format</h3></a>

The optional <tt>format</tt> element defines the Format object classname which
is applied to all pages.

<pre class="codeDtd">
&lt;!ELEMENT <span class="blue">format</span> (#PCDATA)&gt;
    &lt;ATTLIST format classname CDATA #FIXED "net.sf.click.util.Format"&gt; 
</pre>

By default all Click pages are configured with a 
<a target="topic" href="click-api/net/sf/click/util/Format.html">net.sf.click.util.Format</a>
object. The format object made available in the Velocity page templates using the name 
<tt>$<span class="blue">format</span></tt>.
<p/>
To specify a custom format class configure a <tt>format</tt> element in the click-app
descriptor. For example:

<pre class="codeConfig">
&lt;click-app&gt; 
  ..
  &lt;<span class="blue">format</span> classname="<span class="red">com.mycorp.util.CustomFormat</span>"/&gt;
&lt;/click-app&gt; 
</pre>


<a name="application-mode" class="heading"><h3>Mode</h3></a>

The optional <tt>mode</tt> element defines the application logging and caching mode.

<pre class="codeDtd">
&lt;!ELEMENT mode (#PCDATA)&gt;
    &lt;ATTLIST mode value (<span class="blue">production</span>|<span class="blue">profile</span>|<span class="blue">development</span>|<span class="blue">debug</span>) "development"&gt;
</pre>

By default Click applications run in <tt>development</tt> mode which switches off page
template caching and provides <tt>INFO</tt> level logging. 
<p/>
To change the default application mode configure a mode element in the click-app 
descriptor. For example to specify <tt>production</tt> mode you would add the 
following mode element:

<pre class="codeConfig">
&lt;click-app&gt;
  ..
  &lt;<span class="blue">mode</span> value="<span class="red">production</span>"&gt;
&lt;/click-app&gt; 
</pre>

The Click Application modes and their settings for Velocity caching, template loading on startup and 
logging levels are:
<p>
<table style="border: 1px solid black;" cellspacing="0" cellpadding="6">
<tr style="background-color: navy; color: white;">
 <th align="center">Application mode</th>
 <th align="center">Velocity caching</th>
 <th align="center">Load templates on startup</th>
 <th align="center">Click logging level</th>
 <th align="center">Velocity logging level</th>
</tr>
<tr>
 <td align="center"><tt><span class="blue">production</span></tt></td>
 <td align="center">Yes</td>
 <td align="center">Yes</td>
 <td align="center">WARN</td>
 <td align="center">ERROR</td>
</tr>
<tr>
 <td align="center"><tt><span class="blue">profile</span></tt></td>
 <td align="center">Yes</td>
 <td align="center">Yes</td>
 <td align="center">INFO</td>
 <td align="center">ERROR</td>
</tr>
<tr>
 <td align="center"><tt><span class="blue">development</span></tt></td>
 <td align="center">No</td>
 <td align="center">No</td>
 <td align="center">INFO</td>
 <td align="center">ERROR</td>
</tr>
<tr>
 <td align="center"><tt><span class="blue">debug</span></tt></td>
 <td align="center">No</td>
 <td align="center">No</td>
 <td align="center">DEBUG</td>
 <td align="center">WARN</td>
</tr>
</table>

<h4>Velocity Caching</h4>

When Velocity Caching is enabled Velocity page templates and macros files are 
loaded once and cached. With caching enabled following Velocity runtime 
properties are set:

<pre class="codeConfig">
webapp.resource.loader.cache=true
webapp.resource.loader.modificationCheckInterval=0
velocimacro.library.autoreload=false 
</pre>

When Velocity Caching is disabled Velocity templates and macros file are 
reloaded when ever they change. With caching disabled the following Velocity 
runtime properties are set:

<pre class="codeConfig">
webapp.resource.loader.cache=false
velocimacro.library.autoreload=true 
</pre>

Template reloading is useful for application development as you can edit page templates on 
a running application server and see the changes immediately. Note however, this 
should <b>not</b> be used for production as Velocity can use a lot of memory when 
introspecting templates and template reloading is significantly slower.

<h4>Click and Velocity Logging</h4>

The Click and Velocity runtimes are send their logging messages to the 
<a href="servlet-api/javax/servlet/ServletContext.html#log(java.lang.String)">ServletContext</a>
log.
<p/>
Any unhandled <tt>Throwable</tt> errors are logged by the ClickServlet.
<p/>
When an application is not in <tt>production</tt> mode the error page displays
detailed debugging information. When the application mode is <tt>production</tt>
no debug information is displayed to prevent sensitive information being displayed.
This behaviour can be changed by modifying the 
<span class="blue"><tt>error.htm</tt></span> page template.

<a name="velocity-properties" class="heading"><h2>Velocity Properties</h2></a>

The Velocity runtime engine is configured through a series of properties when the 
<tt>ClickServlet</tt> starts up.  The default Velocity properties set are:

<pre class="codeConfig">
resource.loader=webapp

webapp.resource.loader.class=org.apache.velocity.tools.view.servlet.WebappLoader
webapp.resource.loader.cache=[true|false] &nbsp; <span class="green">depending on application mode</span>
webapp.resource.loader.modificationCheckInterval=0 <span class="green">depending on application mode</span>

runtime.log.logsystem.class=org.apache.velocity.runtime.log.Log4JLogSystem
runtime.log.logsystem.log4j.category=org.apache.velocity

velocimacro.library.autoreload=[true|false] <span class="green">depending on application mode</span>
velocimacro.library=click/VM_global_library.vm 
</pre>

See the Velocity
<a target="topic" href="velocity/developer-guide.html#Velocity Configuration Keys and Values">Developer Guide</a>
for details about these properties. Note in <tt>debug</tt> mode the ClickServlet will
log the Velocity properties used when in starts up.
<p/>
If you want to add some of your own Velocity properties, or replace Click's
properties, add a <span class="blue"><tt>velocity.properties</tt></span> file in the <tt>WEB-INF</tt> 
directory. Click will automatically pick up this file and load these properties.
<p/>
As a example say we have our own Velocity macro library called 
<tt>mycorp.vm</tt> we can override the default <tt>velocimacro.library</tt>
property by adding a <tt>WEB-INF/velocity.properties</tt> file to our web
application. In this file we would then define the property as:

<pre class="codeConfig">
velocimacro.library=<span class="blue">mycorp.vm</span> 
</pre>

Note do not place Velocity macros under the WEB-INF directory as the Velocity
ResourceManager will not be able to load them.
<p/>
The simplest way to set your own macro file is to add a file named <span class="blue"><tt>macro.vm</tt></span>
under your web application's root directory. At startup Click will first check to see
if this file exists, and if it does use it instead of <tt>click/VM_global_library.vm</tt>.


<a name="auto-deployed-files" class="heading"><h2>Auto Deployed Files</h2></a> 
At startup the ClickServlet will automatically deploy support files into the
web application, if not already present. You can modify these support files and 
Click will not overwrite them. These files include:

<ul>
   <li>click/calendar.gif &nbsp; - &nbsp; the DateField calendar image</li>
   <li>click/error.htm &nbsp; - &nbsp; the Page <a href="pages.html#page-error-handling">Error Handling</a> template</li>
   <li>click/form.css &nbsp; - &nbsp; the Form cascading stylesheet</li>
   <li>click/form.js &nbsp; - &nbsp; the Form JavaScript library</li>
   <li>click/not-found.htm &nbsp; - &nbsp; the <a href="pages.html#page-not-found">Page Not Found</a> template</li>
   <li>click/VM_Global_library.vm &nbsp; - &nbsp; an empty Velocity macro library</li>
</ul>


</body>
</html>