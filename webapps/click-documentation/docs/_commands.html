<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
 <link rel="stylesheet" type="text/css" href="../help.css">
</head>
<body>
<h1>TODO: rewrite</h1>  
  
<h1>Commands</h1>
<p/>
Commands provide the Click application Java code. &nbsp; 
Click commands broadly follow the "Command" design pattern described by 
Gamma, Helm, Johnson and Vlissides in the book <i>Design Patterns</i>. 
<p>


<h3>Command Objects</h3>
The major <a target="topic" href="api/net/sf/click/command/package-summary.html">net.sf.click.command</a> package objects are: 
<ul>
 <li><a target="topic" href="api/net/sf/click/command/Command.html">Command</a>
 &nbsp; - &nbsp; the command pattern interface 
 <p></li>
 <li><a target="topic" href="api/net/sf/click/command/CommandContext.html">CommandContext</a>
 &nbsp; - &nbsp; the commands execution context, e.g. servet request, session, properties, etc.
 <p></li>
 <li><a target="topic" href="api/net/sf/click/command/BaseCommand.html">BaseCommand</a>
 &nbsp; - &nbsp; provides a base implementation of the command interface 
 <p></li>
 <li><a target="topic" href="api/net/sf/click/command/Control.html">Control</a>
 &nbsp; - &nbsp; the control interface, which is used by HTML controls
 <p></li>
</ul>

Commands are thread safe objects, with one command created for each servlet request. &nbsp; As commands are throw away objects
they should be kept fairly lean to maintain performance and scalablity.

<h3>Execution</h3>
The execution of commands by the <a target="topic" href="api/net/sf/click/ClickServlet.html"><tt>ClickServlet</tt></a>
 is fairly simple.  The main execution sequence is:
<ol>
<li>The request URL is examined to see what command is mapped to it.
The <tt>ClickServlet</tt> then gets a preloaded <tt>Constructor</tt> for the 
command, and creates a new <tt>CommandContext</tt>.<p>
</li>
<li>A new <tt>Command</tt> is created from the <tt>Constructor</tt>
using the <tt>CommandContext</tt> as a parameter.<p> 
</li>
<li>The command's <tt>securityCheck()</tt> method is then called.
This is the commands chance to check the users security credentials before the
<tt>execute()</tt> method is called.
<p>
If the user is not authorized to execute the command <tt>securityCheck()</tt> 
should throw a 
<a target="topic" href="api/net/sf/click/command/RedirectException.html"><tt>RedirectException</tt></a>
to forward another command or resource. For example:<p> 
<blockquote><pre>public void securityCheck() throws RedirectException {
    if (!isUserInSession()) {
        throw new RedirectException("login");
    }
}
</pre></blockquote>

<li>The <tt>execute()</tt> method is then called. 
This is where application business logic is performed. For example:
<blockquote><pre>public void execute() {
    try {
        String surname = getRequest().getParameter("surname");
 
        List customerList = CustomerDAO.findBySurname(surname);

        getModel().put("customerList", customerList);

    } catch (DAOException daoe) {
        throw new ApplicationException(daoe);
    }
}
</pre></blockquote>
</li>
<li>
Next the <tt>ClickServlet</tt> examines the <tt>CommandContext</tt> to see
whether the request should be forwarded to another command, or whether the 
command model should be rendered in a page. 
</li>
</ol>

<h4>Alternative Flows</h4>

Alternative command execution flows are:

<ul>

<li>
If a command's constructor throws an <tt>Exception</tt> (excluding <tt>RedirectException</tt>) the exception 
is handled by the <a target='topic' href="#error-handling">error</a> command.
<p>

<li>
If a command's <tt>execute</tt> or <tt>securityCheck</tt> methods throws a
<tt>RuntimeException</tt> (excluding <tt>RedirectException</tt>) the exception 
is handled by the <a target='topic' href="#error-handling">error</a> command.
<p>

<li>
If the request URL has no command mapped to it, the request is handled by the 
<tt>home</tt> command and a warning message is logged.
</ul>

<h3>Configuration</h3>

Click commands are setup the <tt>commands</tt> element of the application 
<a target="topic" href="configuration.html#application-configuration">configuration</a> 
file. The <tt>commands</tt> element DTD description is defined below: 

<blockquote><pre>&lt;!ELEMENT <font color="blue">commands</font> (<font color="blue">command</font>*, <font color="blue">common-properites</font>?)&gt;
</pre></blockquote>

An application may contain many commands. These commands may also have a set of
common properties contained in the <tt>common-properties</tt> element. 
<p>
The <tt>command</tt> element naturally enough describes configuration of a Click 
command.

The <tt>command</tt> element DTD description is defined below: 

<blockquote><pre>&lt;!ELEMENT <font color="blue">command</font> (<font color="blue">property</font>*)&gt;
   &lt;!ATTLIST command <font color="blue">name</font> CDATA #REQUIRED&gt;
   &lt;!ATTLIST command <font color="blue">url</font> CDATA #REQUIRED&gt;
   &lt;!ATTLIST command <font color="blue">page</font> CDATA #IMPLIED&gt;
   &lt;!ATTLIST command <font color="blue">classname</font> CDATA #FIXED "net.sf.click.command.BaseCommand"&gt;
</pre></blockquote>

The Click command is made up of a series of attributes which define it. These attributes are:
<ul>
<li>name 
&nbsp; - &nbsp; the name of the command, must be unique
<p></li>
<li>url
&nbsp; - &nbsp; the request URL the command is mapped to by the <tt>ClickServlet</tt>
<p></li>
<li>page
&nbsp; - &nbsp; the default page used to render the command response
<p></li>
<li>classname
&nbsp; - &nbsp; the full Java class name of the command, defaults to 
<a target="topic" href="api/net/sf/click/command/BaseCommand.html">BaseCommand</a>
<p></li>
</ul>
For example an application may configure the home, login and logout commands as:
<blockquote><pre>&lt;commands&gt;
   &lt;command name="home" url="index.html" page="home"/&gt;
   &lt;command name="login" url="login.html" page="login" classname="com.mycorp.banking.Login"/&gt;
   &lt;command name="logout" url="logout.html" page="logout" classname="com.mycorp.banking.Logout"/&gt;
&lt;/commands&gt;
</pre></blockquote>

<h4>Properties</h4>

A command may also contain a series of configuration <tt>property</tt> elements which
are made available to a command via the 
<a target="topic" href="api/net/sf/click/command/CommandContext.html#getProperties()">CommandContext</a> 
object. The properties are returned in an unmodifiable <tt>Map</tt>. Properties can 
be of the <tt>java.lang</tt> type <tt>String</tt>, <tt>Integer</tt>, <tt>Boolean</tt> 
or <tt>Double</tt>.
<p>
The <tt>property</tt> element DTD description is defined below: 

<blockquote><pre>&lt;!ELEMENT <font color="blue">property</font> (#PCDATA)&gt;
   &lt;!ATTLIST property <font color="blue">name</font> CDATA #REQUIRED&gt;
   &lt;!ATTLIST property <font color="blue">value</font> CDATA #REQUIRED&gt;
   &lt;!ATTLIST property <font color="blue">type</font> (String|Integer|Boolean|Double) "String"&gt;   
</pre></blockquote>

<p> 
The example below provides a couple of SQL <tt>String</tt> properties for a <tt>Search</tt> command.
<blockquote><pre>&lt;command name="search" url="search.html" page="search" classname="com.mycorp.banking.Search"/&gt;
   &lt;property name="search-account" value="SELECT * FROM customer WHERE account_id = ?"/&gt;
   &lt;property name="search-name" value="SELECT * FROM customer WHERE name LIKE '%?%'"/&gt;
&lt;/command&gt;
</pre></blockquote>

We could also specify maximum number of login attempts property for our <tt>Login</tt> command.
<blockquote><pre>&lt;command name="login" url="login.html" page="login" classname="com.mycorp.banking.Login"&gt;
   &lt;property name="max-login-attempts" value="3" type="Integer"/&gt;
&lt;/command&gt;
</pre></blockquote>

You can then access this property using the <tt>BaseCommand</tt> method
<a target="topic" href="api/net/sf/click/command/BaseCommand.html#getProperties()"><tt>getProperties()</tt></a>.
For example:
<blockquote><pre>public void execute() {
   Integer maxLoginAttempts = (Integer) getProperties().get("max-login-attempts");
}
</pre></blockquote>

<h4>Common Properties</h4>

You can also specify common properties for all your application's commands using
the <tt>common-properties</tt> element. The <tt>common-properties</tt> element 
DTD description is defined below: 

<blockquote><pre> &lt;!ELEMENT <font color="blue">common-properites</font> (<font color="blue">property</font>*)&gt;     
</pre></blockquote>

For example if we have a number of commands which subclass  
<a target="topic" href="api/net/sf/click/command/DataCommand.html"><tt>DataCommand</tt></a>
we can configure the <tt>DataCommand</tt> property <tt>data-command.jndi-datasource</tt>
as a common property.
<blockquote><pre>&lt;commands&gt;
   &lt;command name="home" url="index.html" page="home"/&gt;
   &lt;command name="search" url="search.html" page="search" classname="com.mycorp.shop.Search"/&gt;
   &lt;command name="purchase" url="purchase.html" page="purchase" classname="com.mycorp.shop.Purchase"/&gt;
   &lt;common-properties&gt;
      &lt;property name="data-command.jndi-datasource" value="jdbc/CORP-DB"/&gt;
   &lt;/common-properties&gt;   
&lt;/commands&gt;
</pre></blockquote>


<a name="#navigation"></a>

<h3>Navigation</h3>
There are a number of ways to navigate from a command to a page or other commands.
These navigation or execution paths paths are listed below:
<ol>
<li>The default path is the command's page will render the HTML response for 
the request. For example the following command would be rendered with the 
<tt>login</tt> page.
<blockquote><pre>&ltcommand name="login" url="login" page="<font color="blue">login</font>" classname="com.mycorp.Login"/&gt;
</pre></blockquote>
<p></li>
<li>The command can set another page to render the HTML response with. For example:
<blockquote><pre>setPage("<font color="blue">home</font>");
</pre></blockquote>
<p></li>
<li>The command can set another command the request should be forwarded to 
for further processing. For example:
<blockquote><pre>setRedirectTarget("<font color="blue">login</font>");
</pre></blockquote>
<p></li>
<li>A command can throw a
<a target="topic" href="api/net/sf/click/command/RedirectException.html"><tt>RedirectException</tt></a>,
which can forward the command to another named command or directly to a page for 
rendering. For example:
<blockquote><pre>// Redirect to logout command.
throw new RedirectException("<font color="blue">logout</font>");
</pre></blockquote>
Or redirect to a page:
<blockquote><pre>// Redirect to home page.
throw new RedirectException("<font color="blue">home</font>", <b>false</b>);
</pre></blockquote> 
<p></li>
</ol>


<a name="error-handling"></a>

<h3>Error Handling</h3>
Exceptions raised when executing commands or rendering Velocity templates are
handled by the <tt>error</tt> command. The <tt>error</tt> command the renders
the error debugging information in the <tt>error</tt> page.
<p>
By default Click provides an error command 
<a target="topic" href="api/net/sf/click/command/ErrorCommand.html"><tt>ErrorCommand</tt></a>
and error page '<tt>click/error.html</tt>' preconfigured. If you want to tailor 
the error page simply edit the auto deployed '<tt>click/error.html</tt>' file, 
or configure your own error page. For example:
<blockquote><pre>&ltpage name="<font color="blue">error</font>" path="mycorp-error.html"/&gt;
</pre></blockquote>
If you need to provide your own error processing logic, create your own error
command and configure it in the Click application descriptor. For example:
<blockquote><pre>&ltcommand name="<font color="blue">error</font>" page="error" classname="com.mycorp.banking.BankError"/&gt;
</pre></blockquote>
The error command is passed the following request attributes:
<ul>
<li><tt>error-exception</tt> &nbsp; - &nbsp; the exception causing the error<p></li>
<li><tt>error-command</tt> &nbsp; - &nbsp; the original command causing the error<p></li>
<li><tt>error-page-path</tt> &nbsp; - &nbsp; the original target page path<p></li>
</ul>
These attribute names are defined as constants <tt>ERROR_EXCEPTION</tt>, 
<tt>ERROR_COMMAND</tt> and <tt>ERROR_PAGE_PATH</tt> in   
<a target="topic" href="api/net/sf/click/ClickServlet.html"><tt>ClickServlet</tt></a>.


<a name="cachable-commands"></a>

<h3>Cachable Commands</h3>
Click supports the Servlet API HTTP caching features to enhance application 
performance. If a command implements the 
<a target="topic" href="api/net/sf/click/command/Cachable.html"><tt>Cachable</tt></a>
interface the <tt>ClickServlet</tt> will delegate the 
<A HREF="api/net/sf/click/ClickServlet.html#getLastModified(javax.servlet.http.HttpServletRequest)"><tt>getLastModified()</tt></A>
call to the command.
<p>
For a good discussion on HTTP caching see Rod Johnson's book <i>Expert One-on-One J2EE Design
and Development</i>. Also see Rod's recommended reading list for caching:  
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sect14.html">RFC 2626 Section 14</a>
and <a href="www.mnot.net/cache_docs/">www.mnot.net/cache_docs/</a>. 

</body>
</html>