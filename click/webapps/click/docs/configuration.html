<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
 "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
 <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
 <meta name="Author" content="Malcolm Edgar"/>
 <link rel="stylesheet" type="text/css" href="../help.css"/>
</head>
<body>
  
<h1>Configuration</h1>
<p/>
This section discusses how to setup a Click web application using its 
configuration files.

<blockquote>
<img alt="Click application configuration files" src="../images/config-files.png"/>  
</blockquote>

<p/>
These files include:
<ul>
 <li>WEB-INF/classes/<a target='topic' href="#log4j-properties">log4j.properties</a>
 &nbsp; - &nbsp; Log4j Properties (optional) 
 <p></li>
 <li>WEB-INF/<a target='topic' href="#application-configuration">click.xml</a>
 &nbsp; - &nbsp; Application Configuration (<b>required</b>)
 <p></li>
 <li>WEB-INF/<a target='topic' href="#velocity-properties">velocity.properties</a>
 &nbsp; - &nbsp; Velocity Properties (optional)
 <p></li>
 <li>WEB-INF/<a target='topic' href="#servlet-configuration">web.xml</a>
 &nbsp; - &nbsp; Servlet Configuration (<b>required</b>)
 <p></li>
</ul>

<p>&nbsp;</p>
<a name="servlet-configuration"><h2>Servlet Configuration</h2></a>

For a Click web application to function the 
<a target="topic" href="click-api/net/sf/click/ClickServlet.html">ClickServlet</a>
must be configured in the web application's <tt>/WEB-INF/web.xml</tt> file. 
A simple web application which maps all <tt>*.htm</tt> requests to a ClickServlet 
is provided below.
<blockquote><pre>
&lt;web-app>
   &lt;servlet&gt;
      &lt;servlet-name&gt;<font color="blue">click-servlet</font>&lt;/servlet-name&gt;
      &lt;servlet-class&gt;<font color="red">net.sf.click.ClickServlet</font>&lt;/servlet-class&gt;
      &lt;load-on-startup&gt;<font color="red">0</font>&lt;/load-on-startup&gt;
   &lt;/servlet&gt;
   &lt;servlet-mapping&gt;
      &lt;servlet-name&gt;<font color="blue">click-servlet</font>&lt;/servlet-name&gt;
      &lt;url-pattern&gt;<font color="red">*.htm</font>&lt;/url-pattern&gt;
   &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</pre></blockquote>
<p/>
By default the <tt>ClickServlet</tt> will attempt to load an application
configuration file using the path: &nbsp; <tt>/WEB-INF/click.xml</tt>

<h3>Servlet Mapping</h3>
By convention all Click page templates should have a .htm extension, and
the ClickServlet should be mapped to process all *.htm URL requests. With
this convention you have all the static HTML pages use a .html extension
and they will not be processed as Click pages.

<h3>Load On Startup</h3>
Note you should always set <tt>load-on-startup</tt> element to be 0 so the
servlet is initialized when the server is started. This will prevent any
delay for the first client which uses the application. 
<p/>
The <tt>ClickServlet</tt> performs as much work as possible at startup to
improve performance later on. The Click start up and caching strategy is
configured with the Click application mode element in the "<tt>click.xml</tt>"
config file.


<a name="application-configuration"><h2>Application Configuration</h2></a>

The heart of a Click appliation is the <tt>click.xml</tt> configuration file.
This file specifies the application pages, headers, the format object and the 
applications mode. 

<p/>
See <a target='topic' href="click.dtd">Click DTD</a> for the click-app XML definition.  
 
<p/>
A simple example Click app config file is provided below:

<blockquote><pre>
&lt;click-app&gt; 
  &lt;pages&gt;
    &lt;page path="<font color="blue">index.htm</font>" classname="<font color="blue">com.mycorp.page.Home</font>"/&gt;
    &lt;page path="<font color="blue">login.htm</font>" classname="<font color="blue">com.mycorp.page.Login</font>"/&gt;
    &lt;page path="<font color="blue">logout.htm</font>" classname="<font color="blue">com.mycorp.page.Logout</font>"/&gt;    
    &lt;page path="<font color="blue">search.htm</font>" classname="<font color="blue">com.mycorp.page.Search</font>"/&gt;
  &lt;/pages&gt;
&lt;/click-app&gt; 
</pre></blockquote>

<p>
An example of a fully optioned up config file is:

<blockquote><pre>
&lt;click-app&gt; 
  &lt;pages&gt;
    &lt;page path="<font color="blue">index.htm</font>" classname="<font color="blue">com.mycorp.page.Home</font>"/&gt;
    &lt;page path="<font color="blue">login.htm</font>" classname="<font color="blue">com.mycorp.page.Login</font>"/&gt;
    &lt;page path="<font color="blue">logout.htm</font>" classname="<font color="blue">com.mycorp.page.Logout</font>"/&gt;    
    &lt;page path="<font color="blue">search.htm</font>" classname="<font color="blue">com.mycorp.page.Search</font>"/&gt;
  &lt;/pages&gt;
  &lt;headers&gt;
    &lt;header name="<font color="blue">Pragma</font>" value="<font color="blue">no-cache</font>"/&gt;
    &lt;header name="<font color="blue">Cache-Control</font>" value="<font color="blue">no-cache</font>"/&gt;
  &lt;/headers&gt;
  &lt;format classname="<font color="blue">com.mycorp.util.Format</font>"/&gt;
  &lt;mode value="<font color="blue">debug</font>"/&gt;
&lt;/click-app&gt; 
</pre></blockquote>

<a name="application-pages"></a>
<h3>Pages</h3>

The first major element of the click-app is the mandatory <tt>pages</tt> element 
which defines the list of Click pages.

<blockquote>
<pre>&lt;!ELEMENT <font color="blue">pages</font> (<font color="red">page</font>*)&gt;
</pre>
</blockquote>

The <font color="red">page</font> element defines the Click application pages.

<blockquote>
<pre>&lt;!ELEMENT <font color="red">page</font> (<font color="blue">header</font>*)&gt;
   &lt;!ATTLIST page <font color="blue">path</font> CDATA #REQUIRED&gt;
   &lt;!ATTLIST page <font color="blue">classname</font> CDATA #REQUIRED&gt;
</pre>
</blockquote>

Each page <font color="blue">path</font> must be unique, as the Click application maps HTTP requests to the page paths.
<p/>
The Click application will create a new Page instance for the given request using
the configured page <font color="blue">classname</font>. All pages must subclass 
<a target="topic" href="click-api/net/sf/click/Page.html">Page</a>  
and provide a public no arguments constructor, so they can be instantiated.
<p/>
Pages can also define <font color="blue">header</font> values which are discussed
in the next topic.
<p/>
When the Click application starts up it will check all the page definitions. If there 
is a critical configuration error the ClickSerlvet will log an <tt>ERROR</tt> message and throw a
<a target="topic" href="servlet-api/javax/servlet/UnavailableException.html">UnavailableException</a>. 
If this occurs the click application will be permanantly unavailable until the error is fixed 
and the web app is restarted.

<a name="application-headers"><h3>Headers</h3></a>

The optional <tt>headers</tt> element defines a list of <tt>header</tt> elements
which is applied to all pages.

<blockquote>
<pre>&lt;!ELEMENT <font color="blue">headers</font> (<font color="red">header</font>*)&gt;
</pre>
</blockquote>

The <tt><font color="red">header</font></tt> element defines header name and value
pairs which are applied to the 
<a target="topic" href="servlet-api/javax/servlet/http/HttpServletResponse.html">HttpServletResponse</a>.

<blockquote>
<pre>
&lt;!ELEMENT <font color="red">header</font> (#PCDATA)&gt;
   &lt;!ATTLIST header <font color="blue">name</font> CDATA #REQUIRED&gt;
   &lt;!ATTLIST header <font color="blue">value</font> CDATA #REQUIRED&gt;
   &lt;!ATTLIST header <font color="blue">type</font> (String|Integer|Date) "String"&gt;
</pre>  
</blockquote>

Page headers are set after the Page has been constructed and before <tt>onInit()</tt> is called.
Pages can then modify their 
<a target="topic" href="click-api/net/sf/click/Page.html#headers">headers</a> property.

<h4>Browser Caching</h4>

Headers are typically used to switch off browser caching. You can do this individually 
in pages or for all application pages by setting header values. For example to switch off
caching in the login page, note the value for a Date type should be a long number value:

<blockquote>
<pre>
&lt;page path="<font color="blue">login.htm</font>" classname="<font color="blue">com.mycorp.page.Login</font>"/&gt;
    &lt;header name="<font color="blue">Pragma</font>" value="<font color="blue">no-cache</font>"/&gt;
    &lt;header name="<font color="blue">Cache-Control</font>" value="<font color="blue">no-cache</font>"/&gt;
    &lt;header name="<font color="blue">Expires</font>" value="<font color="blue">1</font>" type="<font color="blue">Date</font>"/&gt;
&lt;/page&gt;
</pre>
</blockquote>

To apply header values globally define header values in the headers element. For example:

<blockquote><pre>
&lt;click-app&gt; 
  &lt;pages&gt;
     ..
  &lt;/pages&gt;
  &lt;headers&gt;
    &lt;header name="<font color="blue">Pragma</font>" value="<font color="blue">no-cache</font>"/&gt;
    &lt;header name="<font color="blue">Cache-Control</font>" value="<font color="blue">no-cache</font>"/&gt;
    &lt;header name="<font color="blue">Expires</font>" value="<font color="blue">1</font>" type="<font color="blue">Date</font>"/&gt;
  &lt;/headers&gt;
&lt;/click-app&gt; 
</pre></blockquote>

<h4>GZIP Encoding</h4>

By setting a "<tt>Content-Encoding</tt>" header value to "<tt>gzip</tt>" the ClickServlet will apply 
GZIP compression to the HTML output. The ClickServlet will only compression if there is a "<tt>Accept-Encoding</tt>" HTTP request header 
which includes <tt>gzip</tt>.

<blockquote>
<pre>
&lt;header name="<font color="blue">Content-Encoding</font>" value="<font color="blue">gzip</font>"/&gt;
</pre>
</blockquote>

Note there are alternative ways to apply HTTP compression such as using the Apache web server module
<tt>mod_gzip</tt>, or using a ServletFilter.


<a name="application-format"><h3>Format</h3></a>

The optional <tt>format</tt> element defines the Format object classname which
is applied to all pages.

<blockquote>
<pre>&lt;!ELEMENT <font color="blue">format</font> (#PCDATA)&gt;
    &lt;ATTLIST format classname CDATA #FIXED "net.sf.click.util.Format"&gt;
</pre>
</blockquote>

By default all Click pages are configured with a 
<a target="topic" href="click-api/net/sf/click/util/Format.html">net.sf.click.util.Format</a>
object. The format object made available in the Velocity page templates using the name 
<tt>$<font color="blue">format</font></tt>.
<p/>
To specify a custom format class configure a <tt>format</tt> element in the click-app
descriptor. For example:

<blockquote><pre>
&lt;click-app&gt; 
  ..
  &lt;<font color="blue">format</font> classname="<font color="red">com.mycorp.util.CustomFormat</font>"/&gt;
&lt;/click-app&gt; 
</pre></blockquote>


<a name="application-mode"><h3>Mode</h3></a>

The optional <tt>mode</tt> element defines the application logging and caching mode.

<blockquote>
<pre>&lt;!ELEMENT mode (#PCDATA)&gt;
    &lt;ATTLIST mode value (<font color="blue">production</font>|<font color="blue">profile</font>|<font color="blue">development</font>|<font color="blue">debug</font>) "development"&gt;
</pre>
</blockquote>

By default Click applications run in <tt>development</tt> mode which switches off page
template caching and provides <tt>INFO</tt> level logging. 
<p/>
To change the default application mode configure a mode element in the click-app 
descriptor. For example to specify <tt>production</tt> mode you would add the 
following mode element:

<blockquote>
<pre>&lt;click-app&gt;
  ..
  &lt;<font color="blue">mode</font> value="<font color="red">production</font>"&gt;
&lt;/click-app&gt;
</pre>
</blockquote>

<p/>

Application modes include:
<ul>
 <li><tt>production</tt> &nbsp; - &nbsp; for production deployment</li>
 <li><tt>profile</tt> &nbsp; - &nbsp; for application profiling</li>
 <li><tt>development</tt> &nbsp; - &nbsp; for application development</li>
 <li><tt>debug</tt> &nbsp; - &nbsp; for application debugging</li>
</ul>

<p>
The table below details the Click application and Velocity runtime Log4J 
<tt>Logger</tt> levels, the Velocity template caching and ClickServlet load page on
startup status for each application mode.
<p>
<table border="1" cellspacing="0" cellpadding="2">
<tr style="{background:navy; color:white}">
 <th align="center">Mode</th>
 <th align="center">Click Logger Level</th>
 <th align="center">Velocity Logger Level</th>
 <th align="center">Velocity Caching</th>
 <th align="center">Load Pages on Startup</th>
</tr>
<tr>
 <td align="center"><tt><font color="blue">production</font></tt></td>
 <td align="center">WARN</td>
 <td align="center">ERROR</td>
 <td align="center">Yes</td>
 <td align="center">Yes</td>
</tr>
<tr>
 <td align="center"><tt><font color="blue">profile</font></tt></td>
 <td align="center">INFO</td>
 <td align="center">ERROR</td>
 <td align="center">Yes</td>
 <td align="center">Yes</td>
</tr>
<tr>
 <td align="center"><tt><font color="blue">development</font></tt></td>
 <td align="center">INFO</td>
 <td align="center">ERROR</td>
 <td align="center">No</td>
 <td align="center">No</td>
</tr>
<tr>
 <td align="center"><tt><font color="blue">debug</font></tt></td>
 <td align="center">DEBUG</td>
 <td align="center">WARN</td>
 <td align="center">No</td>
 <td align="center">No</td>
</tr>
</table>
<p>
When Velocity Caching is enabled Velocity page templates and macros files are 
loaded once and cached. With caching enabled following Velocity runtime 
properties are set:
<blockquote>
<pre>file.resource.loader.cache=true
file.resource.loader.modificationCheckInterval=0
velocimacro.library.autoreload=false
</pre>
</blockquote>
When Velocity Caching is disabled Velocity templates and macros file are 
reloaded when ever they change. With caching disabled the the following Velocity 
runtime properties are 
set:
<blockquote>
<pre>file.resource.loader.cache=false
velocimacro.library.autoreload=true
</pre>
</blockquote>

When an application is not in <tt>production</tt> mode the error page displays
detailed debugging information. When the application mode is <tt>production</tt>
no debug information is displayed to prevent sensitive information being displayed.
This behaviour can be changed by modifying the 
<font color="blue"><tt>error.htm</tt></font> page template.


<a name="velocity-properties"><h2>Velocity Properties</h2></a>

The Velocity runtime engine is configured through a series of properties when the 
<tt>ClickServlet</tt> starts up.  The default Velocity properties set are:
<blockquote>
<pre>
file.resource.loader.class=org.apache.velocity.runtime.resource.loader.FileResourceLoader
file.resource.loader.cache=[true|false] &nbsp; <i>depending on application mode</i>
file.resource.loader.modificationCheckInterval=0 <i>depending on application mode</i>
file.resource.loader.path=<i>the servlets real path</i>

resource.loader=file

runtime.log.logsystem.class=org.apache.velocity.runtime.log.SimpleLog4JLogSystem
runtime.log.logsystem.log4j.category=org.apache.velocity

velocimacro.library.autoreload=[true|false] <i>depending on application mode</i>
velocimacro.library=click/VM_global_library.vm
</pre>
</blockquote>

See the Velocity
<a target="topic" href="velocity/developer-guide.html#Velocity Configuration Keys and Values">Developer Guide</a>
for details about these properties. Note in <tt>debug</tt> mode the ClickServlet will
log the Velocity properites used when in starts up.
<p/>
If you want to add some of your own Velocity properties, or replace Click's
properties, add a <tt>velocity.properties</tt> file in the <tt>WEB-INF</tt> 
directory. Click will automatically pick up this file and load these properties.
<p/>
As a example say we have our own Velocity macro library called 
<tt>mycorp.vm</tt> we can override the default <tt>velocimacro.library</tt>
property by adding a <tt>WEB-INF/velocity.properties</tt> file to our web
application. In this file we would then define the property as:
<blockquote><pre>velocimacro.library=<font color="blue">mycorp.vm</font>,click/VM_global_library.vm
</pre></blockquote>

Note do not place Velocity macros under the WEB-INF directory as the Velocity
ResourceManager will not be able to load them.


<a name="log4j-properties"><h2>Log4j Properties</h2></a>

Click provides in built support for the 
<a href="http://jakarta.apache.org/log4j">Log4j</a> 
logging. Pages can declare their own <tt>Logger</tt> instances and use the configured
Log4J infrastructure. For example:  
<blockquote><pre>
public class CustomerList extends Page {

    static final <font color="blue">Logger</font> LOGGER = <font color="blue">Logger</font>.getLogger(CustomerList.class);
  
    public void onGet() {
        try {
            String surname = getRequest().getParameter("surname");
        
            List customerList = CustomerDAO.findBySurname(surname);

            if (LOGGER.isDebugEnabled()) {
                LOGGER.debug("CustomerDAO.findBySurname(" + surname + ")"
                             + " returned " + customerList.size() + " records.");
            }

            getModel().put("customerList", customerList);
            
        } catch (DAOException daoe) {
            LOGGER.error(daoe);
            throw new ApplicationException(daoe);
        }
    }
}
</pre></blockquote>
The Click and the Velocity frameworks have their own Log4j logging categories, 
which they send logging messages to at runtime. The level of these
categories can be set using the application mode attribute. See the
<a href="#application-mode">Application Mode</a> topic for more details. 
<p>
The Log4j facility is configured using a classpath property file <tt>log4j.properties</tt>.
The Click framework includes a <tt>log4j.properties</tt> file in its JAR file. 
This file provides the following default Log4j properties:
<blockquote><pre># Set root category level to INFO and its only appender to A1.
log4j.rootCategory=INFO, A1

# A1 is set to be a ConsoleAppender. 
log4j.appender.A1=org.apache.log4j.ConsoleAppender

# A1 uses PatternLayout.
log4j.appender.A1.layout=org.apache.log4j.PatternLayout
log4j.appender.A1.layout.ConversionPattern=[%p] %c{1} %m%n

</pre></blockquote>
This configuration will display all debug or higher logging messages to the console.

To override this configuration add your own <tt>log4j.properties</tt> file to your
application's classpath.

</body>
</html>